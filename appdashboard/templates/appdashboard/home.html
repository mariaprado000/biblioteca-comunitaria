{% extends 'appdashboard/base.html' %}

{% block title %}Início - Biblioteca Comunitária{% endblock %}

{% block content %}
<div class='jumbotron'>
    <h1 class='display-4'>Bem-vindo à Biblioteca Comunitária!</h1>
    <p class='lead'>Sistema de gerenciamento de biblioteca com controle de livros, leitores e empréstimos.</p>
    <hr class='my-4'>
    {% if user.is_authenticated %}
        <p>Olá, {{ user.first_name }}! 
        {% if user.groups.all.0.name == 'Funcionários' or user.is_superuser %}
            Você está logado como <span class='badge badge-info'>Funcionário</span>
        {% elif user.groups.all.0.name == 'Leitores' %}
            Você está logado como <span class='badge badge-primary'>Leitor</span>
        {% endif %}
        </p>
    {% else %}
        <p>Faça login para acessar o sistema.</p>
        <a class='btn btn-primary btn-lg' href='{% url 'login' %}' role='button'>
            <i class='fas fa-sign-in-alt'></i> Fazer Login
        </a>
    {% endif %}
</div>

{% if user.is_authenticated %}
    {% if user.groups.all.0.name == 'Funcionários' or user.is_superuser %}
        <!-- Dashboard para Funcionários -->
        <h2 class='mb-4'><i class='fas fa-chart-line'></i> Dashboard</h2>
        
        <!-- Estatísticas Gerais -->
        <div class='row mb-4'>
            <div class='col-md-3'>
                <div class='card text-white bg-primary mb-3'>
                    <div class='card-body'>
                        <h5 class='card-title'><i class='fas fa-book'></i> Total de Livros</h5>
                        <h2 class='card-text'>{{ total_livros }}</h2>
                    </div>
                </div>
            </div>
            <div class='col-md-3'>
                <div class='card text-white bg-success mb-3'>
                    <div class='card-body'>
                        <h5 class='card-title'><i class='fas fa-check-circle'></i> Livros Disponíveis</h5>
                        <h2 class='card-text'>{{ livros_disponiveis }}</h2>
                    </div>
                </div>
            </div>
            <div class='col-md-3'>
                <div class='card text-white bg-info mb-3'>
                    <div class='card-body'>
                        <h5 class='card-title'><i class='fas fa-users'></i> Leitores Ativos</h5>
                        <h2 class='card-text'>{{ total_leitores }}</h2>
                    </div>
                </div>
            </div>
            <div class='col-md-3'>
                <div class='card text-white bg-warning mb-3'>
                    <div class='card-body'>
                        <h5 class='card-title'><i class='fas fa-hand-holding'></i> Empréstimos Ativos</h5>
                        <h2 class='card-text'>{{ emprestimos_ativos }}</h2>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Alertas -->
        {% if emprestimos_atrasados > 0 %}
        <div class='alert alert-danger' role='alert'>
            <h4 class='alert-heading'><i class='fas fa-exclamation-triangle'></i> Atenção!</h4>
            <p>Existem <strong>{{ emprestimos_atrasados }}</strong> empréstimos em atraso.</p>
            <hr>
            <p class='mb-0'>
                <a href='{% url 'relatorio_atrasos' %}' class='btn btn-danger btn-sm'>
                    <i class='fas fa-list'></i> Ver Empréstimos em Atraso
                </a>
            </p>
        </div>
        {% endif %}
        
        <!-- Livros Mais Emprestados -->
        <div class='row'>
            <div class='col-md-6'>
                <div class='card'>
                    <div class='card-header'>
                        <h5><i class='fas fa-trophy'></i> Top 5 Livros Mais Emprestados</h5>
                    </div>
                    <div class='card-body'>
                        <table class='table table-sm'>
                            <thead>
                                <tr>
                                    <th>Título</th>
                                    <th>Autor</th>
                                    <th>Empréstimos</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for livro in livros_populares %}
                                <tr>
                                    <td>{{ livro.titulo }}</td>
                                    <td>{{ livro.autor }}</td>
                                    <td><span class='badge badge-primary'>{{ livro.num_emprestimos }}</span></td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan='3' class='text-center'>Nenhum empréstimo realizado ainda.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <a href='{% url 'relatorio_livros_populares' %}' class='btn btn-primary btn-sm'>
                            <i class='fas fa-chart-bar'></i> Ver Relatório Completo
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Ações Rápidas -->
            <div class='col-md-6'>
                <div class='card'>
                    <div class='card-header'>
                        <h5><i class='fas fa-bolt'></i> Ações Rápidas</h5>
                    </div>
                    <div class='card-body'>
                        <div class='list-group'>
                            <a href='{% url 'emprestimo_create' %}' class='list-group-item list-group-item-action'>
                                <i class='fas fa-plus text-success'></i> Novo Empréstimo
                            </a>
                            <a href='{% url 'livro_create' %}' class='list-group-item list-group-item-action'>
                                <i class='fas fa-book text-primary'></i> Cadastrar Livro
                            </a>
                            <a href='{% url 'leitor_create' %}' class='list-group-item list-group-item-action'>
                                <i class='fas fa-user-plus text-info'></i> Cadastrar Leitor
                            </a>
                            <a href='{% url 'emprestimo_list' %}' class='list-group-item list-group-item-action'>
                                <i class='fas fa-undo text-warning'></i> Devolver Livro
                            </a>
                            <a href='{% url 'relatorio_atrasos' %}' class='list-group-item list-group-item-action'>
                                <i class='fas fa-clock text-danger'></i> Ver Atrasos
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    {% elif user.groups.all.0.name == 'Leitores' %}
        <!-- Dashboard para Leitores -->
        <h2 class='mb-4'><i class='fas fa-user'></i> Minha Área</h2>
        
        {% if not user.leitor %}
        <div class='alert alert-warning' role='alert'>
            <h4 class='alert-heading'><i class='fas fa-exclamation-circle'></i> Complete seu cadastro!</h4>
            <p>Para realizar empréstimos, você precisa completar seu cadastro como leitor.</p>
            <hr>
            <p class='mb-0'>
                <a href='{% url 'leitor_create_self' %}' class='btn btn-warning'>
                    <i class='fas fa-user-edit'></i> Completar Cadastro
                </a>
            </p>
        </div>
        {% else %}
            <!-- Empréstimos Ativos -->
            <div class='card mb-4'>
                <div class='card-header'>
                    <h5><i class='fas fa-book-reader'></i> Meus Empréstimos Ativos</h5>
                </div>
                <div class='card-body'>
                    {% if meus_emprestimos %}
                    <table class='table table-striped'>
                        <thead>
                            <tr>
                                <th>Livro</th>
                                <th>Data Empréstimo</th>
                                <th>Devolução Prevista</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for emprestimo in meus_emprestimos %}
                            <tr>
                                <td>{{ emprestimo.livro.titulo }}</td>
                                <td>{{ emprestimo.data_emprestimo|date:'d/m/Y' }}</td>
                                <td>{{ emprestimo.data_devolucao_prevista|date:'d/m/Y' }}</td>
                                <td>
                                    {% if emprestimo.data_devolucao_prevista < today %}
                                        <span class='badge badge-danger'>Em Atraso</span>
                                    {% else %}
                                        <span class='badge badge-success'>No Prazo</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if emprestimo.data_devolucao_prevista >= today %}
                                    <a href='{% url 'emprestimo_renovar' emprestimo.id %}' class='btn btn-sm btn-primary'>
                                        <i class='fas fa-sync'></i> Renovar
                                    </a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class='text-muted'>Você não possui empréstimos ativos no momento.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Histórico -->
            <div class='card'>
                <div class='card-header'>
                    <h5><i class='fas fa-history'></i> Histórico de Empréstimos</h5>
                </div>
                <div class='card-body'>
                    {% if historico_emprestimos %}
                    <table class='table table-sm'>
                        <thead>
                            <tr>
                                <th>Livro</th>
                                <th>Emprestado em</th>
                                <th>Devolvido em</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for emprestimo in historico_emprestimos %}
                            <tr>
                                <td>{{ emprestimo.livro.titulo }}</td>
                                <td>{{ emprestimo.data_emprestimo|date:'d/m/Y' }}</td>
                                <td>
                                    {% if emprestimo.data_devolucao %}
                                        {{ emprestimo.data_devolucao|date:'d/m/Y' }}
                                    {% else %}
                                        <span class='text-warning'>Em andamento</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if emprestimo.multa > 0 %}
                                        <span class='badge badge-danger'>Multa: R$ {{ emprestimo.multa }}</span>
                                    {% else %}
                                        <span class='badge badge-success'>OK</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class='text-muted'>Você ainda não realizou nenhum empréstimo.</p>
                    {% endif %}
                </div>
            </div>
        {% endif %}
        
    {% else %}
        <!-- Usuário sem grupo definido -->
        <div class='alert alert-info' role='alert'>
            <h4 class='alert-heading'>Bem-vindo!</h4>
            <p>Seu cadastro está sendo processado. Em breve você terá acesso completo ao sistema.</p>
        </div>
    {% endif %}
{% endif %}
{% endblock %}
